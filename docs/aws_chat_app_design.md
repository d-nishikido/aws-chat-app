# AWS ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª æ¦‚è¦è¨­è¨ˆæ›¸ï¼ˆBLEAçµ±åˆç‰ˆï¼‰

## 1. BLEAçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BLEAçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¬ãƒãƒŠãƒ³ã‚¹      â”‚    â”‚  ã‚²ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ    â”‚    â”‚ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ â”‚
â”‚   ãƒ™ãƒ¼ã‚¹        â”‚â”€â”€â”€â”€â”‚   (BLEAæ‹¡å¼µ)    â”‚â”€â”€â”€â”€â”‚  (ãƒãƒ£ãƒƒãƒˆç‹¬è‡ª)  â”‚
â”‚ (BLEAæä¾›)      â”‚    â”‚                â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆ¶)      (åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©)         (ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯)
```

### BLEAæ´»ç”¨ã«ã‚ˆã‚‹è‡ªå‹•æä¾›æ©Ÿèƒ½
```
ğŸ”’ ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ï¼ˆBLEAè‡ªå‹•æä¾›ï¼‰:
â”œâ”€â”€ AWS CloudTrail      # APIç›£æŸ»ãƒ­ã‚°
â”œâ”€â”€ AWS Config          # ãƒªã‚½ãƒ¼ã‚¹è¨­å®šç›£æŸ»  
â”œâ”€â”€ AWS Security Hub    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³çµ±åˆç®¡ç†
â”œâ”€â”€ Amazon GuardDuty    # è„…å¨æ¤œçŸ¥
â”œâ”€â”€ AWS Secrets Manager # æ©Ÿå¯†æƒ…å ±ç®¡ç†
â”œâ”€â”€ AWS WAF             # Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·
â””â”€â”€ AWS Chatbot         # Slacké€šçŸ¥ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰

ğŸ—ï¸ ã‚²ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆBLEA + ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼‰:
â”œâ”€â”€ VPC + ã‚µãƒ–ãƒãƒƒãƒˆè¨­è¨ˆ
â”œâ”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
â”œâ”€â”€ IAMãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒªã‚·ãƒ¼ï¼ˆæœ€å°æ¨©é™ï¼‰
â”œâ”€â”€ KMSæš—å·åŒ–ã‚­ãƒ¼
â””â”€â”€ ãƒ­ã‚°é›†ç´„è¨­å®š
```

## 2. BLEAãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

### è©³ç´°ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Management Account                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ CloudTrail (Org) â”‚  â”‚ Config (Org)     â”‚              â”‚
â”‚  â”‚ å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç›£æŸ»  â”‚  â”‚ çµ„ç¹”å…¨ä½“è¨­å®šç›£æŸ»  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Chat App Account (Guest)                  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  CloudFront     â”‚â”€â”€â”€â”€â”‚      S3         â”‚              â”‚
â”‚  â”‚  (CDN/WAF)      â”‚    â”‚  (Static Web)   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                       â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   API Gateway   â”‚â”€â”€â”€â”€â”‚     Lambda      â”‚              â”‚
â”‚  â”‚  (REST/GraphQL) â”‚    â”‚  (Python 3.11) â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                       â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚    Cognito      â”‚    â”‚   Aurora RDS    â”‚              â”‚
â”‚  â”‚  (èªè¨¼/èªå¯)     â”‚    â”‚  (PostgreSQL)   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              BLEA Security Services                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ GuardDuty  â”‚ â”‚SecurityHub â”‚ â”‚ Secrets Managerâ”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. BLEAå°å…¥ãƒ—ãƒ­ã‚»ã‚¹

### Phase 1: BLEAã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹å°å…¥
```bash
# 1. BLEAãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/aws-samples/baseline-environment-on-aws.git
cd baseline-environment-on-aws

# 2. è¨­å®šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
cp packages/baseline/config/parameter.ts packages/baseline/config/parameter.ts.backup
vi packages/baseline/config/parameter.ts

# parameter.ts ã®ä¸»è¦è¨­å®šä¾‹
export const devParameter: DevParameter = {
  env: {
    account: 'YOUR_ACCOUNT_ID',
    region: 'ap-northeast-1',
  },
  securityNotifyEmail: 'security-admin@example.com',
  slackNotifier: {
    workspaceId: 'T1234567890',
    channelId: 'C1234567890',
  },
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  enableGuardDuty: true,
  enableSecurityHub: true,
  enableConfig: true,
  enableChatbot: true,
  
  // ç›£æŸ»è¨­å®š
  cloudTrail: {
    enableCloudTrail: true,
    enableInsightSelector: true,
  },
  
  // WAFè¨­å®š
  webAcl: {
    scope: 'CLOUDFRONT',
    rules: ['AWSManagedRulesCommonRuleSet', 'AWSManagedRulesKnownBadInputsRuleSet'],
  }
};

# 3. ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤
npm install
npx cdk bootstrap
npx cdk deploy --all --require-approval never
```

### Phase 2: ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚²ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
```bash
# 1. ã‚²ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
mkdir chat-app-guest-system
cd chat-app-guest-system

# 2. BLEA Guest System åˆæœŸåŒ–
npx cdk init app --language typescript
npm install @aws-cdk/aws-ec2 @aws-cdk/aws-lambda @aws-cdk/aws-rds @aws-cdk/aws-s3

# 3. BLEAãƒ™ãƒ¼ã‚¹ã®æ‹¡å¼µå®Ÿè£…
cat > lib/chat-app-stack.ts << 'EOF'
import * as cdk from 'aws-cdk-lib';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as rds from 'aws-cdk-lib/aws-rds';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as apigateway from 'aws-cdk-lib/aws-apigateway';
import * as cognito from 'aws-cdk-lib/aws-cognito';
import { Construct } from 'constructs';

export class ChatAppStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // BLEAæº–æ‹ ã®VPCè¨­è¨ˆ
    const vpc = this.createSecureVpc();
    
    // BLEAæº–æ‹ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
    const securityGroups = this.createSecurityGroups(vpc);
    
    // ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªå›ºæœ‰ãƒªã‚½ãƒ¼ã‚¹
    this.createChatInfrastructure(vpc, securityGroups);
  }

  private createSecureVpc(): ec2.Vpc {
    return new ec2.Vpc(this, 'ChatAppVpc', {
      maxAzs: 2,
      natGateways: 1, // ã‚³ã‚¹ãƒˆæœ€é©åŒ–
      subnetConfiguration: [
        {
          cidrMask: 24,
          name: 'Public',
          subnetType: ec2.SubnetType.PUBLIC,
        },
        {
          cidrMask: 24,
          name: 'Private',
          subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS,
        },
        {
          cidrMask: 24,
          name: 'Database',
          subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        },
      ],
      // BLEAæº–æ‹ ã®ã‚¿ã‚°æˆ¦ç•¥
      vpcName: 'ChatApp-VPC',
    });
  }

  private createSecurityGroups(vpc: ec2.Vpc) {
    // Lambdaç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
    const lambdaSg = new ec2.SecurityGroup(this, 'LambdaSecurityGroup', {
      vpc,
      description: 'Security group for Lambda functions',
      allowAllOutbound: true,
    });

    // RDSç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
    const rdsSg = new ec2.SecurityGroup(this, 'RdsSecurityGroup', {
      vpc,
      description: 'Security group for RDS Aurora',
      allowAllOutbound: false,
    });

    // Lambdaã‹ã‚‰RDSã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
    rdsSg.addIngressRule(lambdaSg, ec2.Port.tcp(5432), 'Lambda to RDS');

    return { lambdaSg, rdsSg };
  }

  private createChatInfrastructure(vpc: ec2.Vpc, securityGroups: any) {
    // Aurora PostgreSQL Serverless v2
    // Cognito User Pool
    // Lambda Functions
    // API Gateway
    // S3 + CloudFront
  }
}
EOF

# 4. ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
npx cdk deploy
```

## 4. BLEAçµ±åˆè¨­è¨ˆè©³ç´°

### 4.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è‡ªå‹•åŒ–ï¼ˆBLEAæä¾›ï¼‰

#### GuardDuty è„…å¨æ¤œçŸ¥
```typescript
// BLEAè‡ªå‹•è¨­å®š - GuardDutyæœ‰åŠ¹åŒ–
const guardDutyDetector = new guardduty.CfnDetector(this, 'GuardDutyDetector', {
  enable: true,
  findingPublishingFrequency: 'FIFTEEN_MINUTES',
  dataSources: {
    s3Logs: { enable: true },
    kubernetes: { auditLogs: { enable: true } },
    malwareProtection: { scanEc2InstanceWithFindings: { enable: true } }
  }
});

// è‡ªå‹•é€šçŸ¥è¨­å®š
const guardDutyEventRule = new events.Rule(this, 'GuardDutyEventRule', {
  eventPattern: {
    source: ['aws.guardduty'],
    detailType: ['GuardDuty Finding'],
    detail: {
      severity: [4.0, 10.0] // Mediumä»¥ä¸Šã®è„…å¨
    }
  }
});
```

#### Security Hub çµ±åˆç®¡ç†
```typescript
// BLEAè‡ªå‹•è¨­å®š - Security Hubæœ‰åŠ¹åŒ–
const securityHub = new securityhub.CfnHub(this, 'SecurityHub', {
  tags: [
    { key: 'Environment', value: 'production' },
    { key: 'Project', value: 'ChatApp' }
  ]
});

// CIS Benchmarkã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰è‡ªå‹•æœ‰åŠ¹åŒ–
const cisStandard = new securityhub.CfnStandard(this, 'CISStandard', {
  standardsArn: 'arn:aws:securityhub:::ruleset/finding-format/aws-foundational-security-standard/v/1.0.0'
});
```

#### Config è¨­å®šç›£æŸ»
```typescript
// BLEAè‡ªå‹•è¨­å®š - Config Rules
const configRules = [
  's3-bucket-public-read-prohibited',
  's3-bucket-public-write-prohibited',
  'securitygroup-attached-to-eni',
  'iam-password-policy',
  'rds-storage-encrypted',
  'lambda-function-public-access-prohibited'
];

configRules.forEach(ruleName => {
  new config.ManagedRule(this, `ConfigRule-${ruleName}`, {
    identifier: ruleName,
    inputParameters: this.getConfigRuleParameters(ruleName)
  });
});
```

### 4.2 ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªå›ºæœ‰å®Ÿè£…ï¼ˆBLEAæ‹¡å¼µï¼‰

#### Lambda Functionsï¼ˆBLEAæº–æ‹ ï¼‰
```python
# lambda/chat_handler.py - BLEAç’°å¢ƒã§ã®å®Ÿè£…
import json
import boto3
import os
import logging
from aws_lambda_powertools import Logger, Tracer, Metrics
from aws_lambda_powertools.logging import correlation_paths
from aws_lambda_powertools.metrics import MetricUnit

# BLEAæ¨å¥¨ã®ãƒ­ã‚°è¨­å®š
logger = Logger()
tracer = Tracer()
metrics = Metrics()

@tracer.capture_lambda_handler
@logger.inject_lambda_context(correlation_id_path=correlation_paths.API_GATEWAY_REST)
@metrics.log_metrics
def lambda_handler(event, context):
    """
    BLEAç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
    """
    try:
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼
        if not validate_request(event):
            logger.error("Invalid request format")
            return create_error_response(400, "Invalid request")
        
        # Secrets Managerã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—ï¼ˆBLEAæä¾›ï¼‰
        db_credentials = get_db_credentials_from_secrets_manager()
        
        # Aurora Data APIä½¿ç”¨ï¼ˆVPCå†…ã§ã‚»ã‚­ãƒ¥ã‚¢ï¼‰
        message_id = save_message_to_database(event, db_credentials)
        
        # CloudWatch ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡ï¼ˆBLEAç›£è¦–é€£æºï¼‰
        metrics.add_metric(name="MessagesSent", unit=MetricUnit.Count, value=1)
        
        # EventBridgeçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡
        publish_to_eventbridge(event, message_id)
        
        logger.info("Message sent successfully", extra={"messageId": message_id})
        
        return create_success_response(message_id)
        
    except Exception as e:
        logger.error(f"Error processing message: {str(e)}")
        metrics.add_metric(name="MessageErrors", unit=MetricUnit.Count, value=1)
        
        # BLEA Security Hubé€£æº
        send_security_event_if_needed(e)
        
        return create_error_response(500, "Internal server error")

def get_db_credentials_from_secrets_manager():
    """BLEAæä¾›ã®Secrets Managerã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—"""
    secrets_client = boto3.client('secretsmanager')
    secret_arn = os.environ['DB_SECRET_ARN']  # BLEAç’°å¢ƒå¤‰æ•°
    
    response = secrets_client.get_secret_value(SecretId=secret_arn)
    return json.loads(response['SecretString'])

def validate_request(event):
    """BLEAæº–æ‹ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼"""
    # OWASPæ¨å¥¨ã®å…¥åŠ›æ¤œè¨¼
    # XSS, SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    return True

def send_security_event_if_needed(exception):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’BLEA Security Hubã«é€ä¿¡"""
    if is_security_related_error(exception):
        # Security Hub Findingã¨ã—ã¦é€ä¿¡
        pass
```

#### Aurora Databaseè¨­è¨ˆï¼ˆBLEAæº–æ‹ ï¼‰
```typescript
// BLEAæº–æ‹ ã®Auroraè¨­å®š
const dbCluster = new rds.DatabaseCluster(this, 'ChatAppDatabase', {
  engine: rds.DatabaseClusterEngine.auroraPostgres({
    version: rds.AuroraPostgresEngineVersion.VER_14_9
  }),
  
  // BLEAæ¨å¥¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  credentials: rds.Credentials.fromGeneratedSecret('chatapp-admin', {
    secretName: 'chatapp/database/credentials',
    excludeCharacters: '"@/\\'
  }),
  
  // æš—å·åŒ–å¿…é ˆï¼ˆBLEAè¦ä»¶ï¼‰
  storageEncrypted: true,
  storageEncryptionKey: this.createKmsKey(),
  
  // VPCè¨­å®šï¼ˆBLEAæº–æ‹ ï¼‰
  vpc: vpc,
  vpcSubnets: {
    subnetType: ec2.SubnetType.PRIVATE_ISOLATED
  },
  securityGroups: [securityGroups.rdsSg],
  
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šï¼ˆBLEAæ¨å¥¨ï¼‰
  backup: {
    retention: cdk.Duration.days(7),
    preferredWindow: '03:00-04:00'
  },
  
  // ç›£è¦–è¨­å®šï¼ˆBLEAçµ±åˆï¼‰
  monitoringInterval: cdk.Duration.minutes(1),
  monitoringRole: this.createRdsMonitoringRole(),
  
  // Serverless v2è¨­å®š
  serverlessV2MinCapacity: 0.5,
  serverlessV2MaxCapacity: 4,
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°æœ‰åŠ¹åŒ–
  cloudwatchLogsExports: ['postgresql'],
  
  // BLEAæº–æ‹ ã®ã‚¿ã‚°è¨­å®š
  tags: {
    Project: 'ChatApp',
    Environment: 'production',
    DataClassification: 'internal',
    BackupRequired: 'true'
  }
});
```

### 4.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆBLEA WAFé€£æºï¼‰

#### S3 + CloudFrontï¼ˆBLEA WAFçµ±åˆï¼‰
```typescript
// BLEA WAF ACLã¨ã®çµ±åˆ
const webAcl = new wafv2.CfnWebACL(this, 'ChatAppWebACL', {
  scope: 'CLOUDFRONT',
  defaultAction: { allow: {} },
  
  // BLEAæ¨å¥¨ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆ
  rules: [
    {
      name: 'AWSManagedRulesCommonRuleSet',
      priority: 1,
      statement: {
        managedRuleGroupStatement: {
          vendorName: 'AWS',
          name: 'AWSManagedRulesCommonRuleSet'
        }
      },
      overrideAction: { none: {} },
      visibilityConfig: {
        sampledRequestsEnabled: true,
        cloudWatchMetricsEnabled: true,
        metricName: 'CommonRuleSetMetric'
      }
    },
    {
      name: 'AWSManagedRulesKnownBadInputsRuleSet',
      priority: 2,
      statement: {
        managedRuleGroupStatement: {
          vendorName: 'AWS',
          name: 'AWSManagedRulesKnownBadInputsRuleSet'
        }
      },
      overrideAction: { none: {} },
      visibilityConfig: {
        sampledRequestsEnabled: true,
        cloudWatchMetricsEnabled: true,
        metricName: 'BadInputsRuleSetMetric'
      }
    }
  ]
});

// CloudFront Distributionï¼ˆBLEA WAFé€£æºï¼‰
const distribution = new cloudfront.Distribution(this, 'ChatAppDistribution', {
  defaultBehavior: {
    origin: new origins.S3Origin(websiteBucket, {
      originAccessIdentity: oai
    }),
    viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
    
    // BLEA WAFé©ç”¨
    responseHeadersPolicy: this.createSecurityHeadersPolicy()
  },
  
  // BLEA WAF ACLé–¢é€£ä»˜ã‘
  webAclId: webAcl.attrArn,
  
  // ãƒ­ã‚°è¨­å®šï¼ˆBLEAè¦ä»¶ï¼‰
  enableLogging: true,
  logBucket: this.accessLogBucket,
  logFilePrefix: 'cloudfront-access-logs/',
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  minimumProtocolVersion: cloudfront.SecurityPolicyProtocol.TLS_V1_2_2021,
  
  // BLEAæº–æ‹ ã®ã‚¿ã‚°
  comment: 'ChatApp CloudFront Distribution with BLEA WAF'
});
```

## 5. ç›£è¦–ãƒ»é‹ç”¨ï¼ˆBLEAçµ±åˆï¼‰

### 5.1 BLEAç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

#### CloudWatchçµ±åˆç›£è¦–
```typescript
// BLEAæä¾›ã®çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹¡å¼µ
const chatAppDashboard = new cloudwatch.Dashboard(this, 'ChatAppDashboard', {
  dashboardName: 'BLEA-ChatApp-Monitoring',
  widgets: [
    // BLEAæä¾›ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    [
      new cloudwatch.GraphWidget({
        title: 'Security Events (BLEA)',
        left: [
          new cloudwatch.Metric({
            namespace: 'AWS/SecurityHub',
            metricName: 'Findings',
            dimensionsMap: { ComplianceType: 'FAILED' }
          })
        ]
      })
    ],
    
    // ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    [
      new cloudwatch.GraphWidget({
        title: 'Chat Application Metrics',
        left: [
          new cloudwatch.Metric({
            namespace: 'ChatApp/Messages',
            metricName: 'MessagesSent'
          }),
          new cloudwatch.Metric({
            namespace: 'ChatApp/Users',
            metricName: 'ActiveUsers'
          })
        ]
      })
    ]
  ]
});
```

### 5.2 BLEA Chatboté€šçŸ¥çµ±åˆ

#### Slacké€šçŸ¥è¨­å®š
```typescript
// BLEA Chatbotæ‹¡å¼µ
const chatAppNotifications = new chatbot.SlackChannelConfiguration(this, 'ChatAppSlackNotifications', {
  slackChannelConfigurationName: 'chatapp-alerts',
  slackWorkspaceId: 'T1234567890',
  slackChannelId: 'C1234567890',
  
  // BLEAçµ±åˆã‚¢ãƒ©ãƒ¼ãƒˆ
  notificationTopics: [
    this.securityAlertTopic,  // BLEAæä¾›
    this.costAlertTopic,      // BLEAæä¾›
    this.chatAppAlertTopic    // ã‚¢ãƒ—ãƒªå›ºæœ‰
  ],
  
  // IAMãƒ­ãƒ¼ãƒ«ï¼ˆBLEAæº–æ‹ ã®æœ€å°æ¨©é™ï¼‰
  role: this.createChatbotRole()
});
```

## 6. ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šï¼ˆBLEAçµ±åˆç‰ˆï¼‰

### 6.1 é–‹ç™ºç’°å¢ƒï¼ˆBLEA + ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | ä½¿ç”¨é‡ | æœˆé¡è²»ç”¨ | BLEA | è¿½åŠ  |
|---------|--------|----------|------|------|
| **BLEAåŸºç›¤ã‚µãƒ¼ãƒ“ã‚¹** | | | | |
| CloudTrail | çµ„ç¹”å…¨ä½“ç›£æŸ» | $2.00 | âœ… | |
| Config | è¨­å®šç›£æŸ» | $2.00 | âœ… | |
| Security Hub | çµ±åˆç®¡ç† | $1.50 | âœ… | |
| GuardDuty | è„…å¨æ¤œçŸ¥ | $4.00 | âœ… | |
| Secrets Manager | 5ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | $2.50 | âœ… | |
| **ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª** | | | | |
| Lambda | 10ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆ | $0.20 | | âœ… |
| API Gateway | 10ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆ | $0.35 | | âœ… |
| AppSync | 5ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆ | $2.00 | | âœ… |
| Aurora Serverless v2 | å¹³å‡0.5ACU | $10.80 | | âœ… |
| CloudFront | 1GBè»¢é€/æœˆ | $0.085 | | âœ… |
| S3 | 500MBä¿å­˜ | $0.012 | | âœ… |
| Route53 | 1ãƒ‰ãƒ¡ã‚¤ãƒ³ | $0.50 | | âœ… |
| Cognito | 50MAU | $0.00 | | âœ… |
| CloudWatch | åŸºæœ¬ç›£è¦– | $3.00 | ä¸€éƒ¨âœ… | ä¸€éƒ¨âœ… |
| **åˆè¨ˆ** | | **$28.94** | $12.00 | $16.94 |

### 6.2 æœ¬ç•ªç’°å¢ƒï¼ˆBLEA + ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªï¼‰

| ã‚«ãƒ†ã‚´ãƒª | æœˆé¡è²»ç”¨ | å‚™è€ƒ |
|---------|----------|------|
| **BLEAåŸºç›¤** | $45.00 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç›£æŸ»æ©Ÿèƒ½ |
| **ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª** | $558.40 | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ |
| **åˆè¨ˆ** | **$603.40** | BLEAçµ±åˆã«ã‚ˆã‚‹å®‰å…¨æ€§ç¢ºä¿ |

### 6.3 BLEAå°å…¥ã«ã‚ˆã‚‹ä¾¡å€¤

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾¡å€¤
- **$12.00/æœˆ**: æ‰‹å‹•è¨­å®šã§ã¯æ•°åæ™‚é–“å¿…è¦ãªä½œæ¥­ã‚’è‡ªå‹•åŒ–
- **å·¥æ•°å‰Šæ¸›**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆãƒ»å®Ÿè£…å·¥æ•° 80%å‰Šæ¸›
- **ç¶™ç¶šç›£è¦–**: 24/7ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã®è‡ªå‹•åŒ–

#### ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ä¾¡å€¤
- **è‡ªå‹•ç›£æŸ»**: CIS Benchmarkæº–æ‹ ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
- **è¨¼è·¡ç®¡ç†**: CloudTrailã«ã‚ˆã‚‹å®Œå…¨ãªæ“ä½œå±¥æ­´
- **ãƒ¬ãƒãƒ¼ãƒˆ**: Security Hubã§ã®çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ

## 7. BLEAå­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆ3ãƒ¶æœˆï¼‰

### Month 1: BLEAåŸºç›¤ç†è§£ãƒ»å°å…¥
- **Week 1**: BLEAæ¦‚å¿µç†è§£ + ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹å°å…¥
- **Week 2**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹å‹•ä½œç¢ºèª
- **Week 3**: ã‚²ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
- **Week 4**: åŸºæœ¬çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ

### Month 2: ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªå®Ÿè£…
- **Week 1**: BLEAæº–æ‹ ã®Lambda + Auroraå®Ÿè£…
- **Week 2**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½çµ±åˆï¼ˆèªè¨¼ãƒ»èªå¯ï¼‰
- **Week 3**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ + WAFé€£æº
- **Week 4**: ç›£è¦–ãƒ»ãƒ­ã‚°çµ±åˆ

### Month 3: é‹ç”¨ãƒ»æœ€é©åŒ–
- **Week 1**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»è‡ªå‹•å¯¾å¿œè¨­å®š
- **Week 2**: ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ç›£æŸ»ãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
- **Week 3**: ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼æ§‹ç¯‰
- **Week 4**: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨é–‹å§‹

## 8. BLEAçµ±åˆã«ã‚ˆã‚‹å­¦ç¿’åŠ¹æœ

### 8.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã‚¹ã‚­ãƒ«
- **Well-Architectedæº–æ‹ **: AWSå…¬å¼æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè·µ
- **å¤šå±¤é˜²å¾¡**: GuardDuty + Config + WAFã®çµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ**: æœ€å°æ¨©é™åŸå‰‡ã®è‡ªå‹•é©ç”¨

### 8.2 é‹ç”¨è‡ªå‹•åŒ–ã‚¹ã‚­ãƒ«
- **Infrastructure as Code**: BLEAã®CDKå®Ÿè£…ç†è§£
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨**: è‡ªå‹•æ¤œçŸ¥ãƒ»å¯¾å¿œãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…
- **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**: ç¶™ç¶šçš„ãªè¨­å®šç›£æŸ»ã‚·ã‚¹ãƒ†ãƒ 

### 8.3 ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæº–æ‹ 
- **çµ„ç¹”ãƒ¬ãƒ™ãƒ«è¨­è¨ˆ**: è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã®å®Ÿè·µ
- **ã‚¬ãƒãƒŠãƒ³ã‚¹**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã®è‡ªå‹•é©ç”¨
- **ç›£æŸ»å¯¾å¿œ**: å®Œå…¨ãªè¨¼è·¡ç®¡ç†ã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

ã“ã® BLEAçµ±åˆè¨­è¨ˆã«ã‚ˆã‚Šã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã®å®Ÿè£…ã‚’é€šã˜ã¦ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ»é‹ç”¨ã‚’å­¦ç¿’ã§ãã¾ã™ã€‚æ‰‹å‹•è¨­å®šã§ã¯å›°é›£ãªé«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’ã€BLEAã®è‡ªå‹•åŒ–ã«ã‚ˆã‚ŠåŠ¹ç‡çš„ã«ç¿’å¾—ã§ãã¾ã™ã€‚