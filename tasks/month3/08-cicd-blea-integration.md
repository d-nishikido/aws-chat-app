# Task: BLEAæº–æ‹ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰

**å®Ÿæ–½æœŸé–“**: Month 3 Week 1 (Day 1-2)  
**æ¨å®šå·¥æ•°**: 8æ™‚é–“  
**å„ªå…ˆåº¦**: é«˜  

## æ¦‚è¦

BLEAã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã™CDKçµ±ä¸€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã€GitHub Actionsã¨AWS CDK Pipelinesã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## å­¦ç¿’ç›®æ¨™

- BLEAæº–æ‹ ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®çµ±åˆ
- CDKçµ±åˆãƒ†ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
- è‡ªå‹•æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã®å®Ÿè£…

## å‰ææ¡ä»¶

- Month 2ã®å…¨ã‚¿ã‚¹ã‚¯å®Œäº†
- BLEAåŸºç›¤ãŒå®‰å®šç¨¼åƒ
- å…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒå®Ÿè£…å®Œäº†

## ã‚¿ã‚¹ã‚¯è©³ç´°

### Day 1: BLEAçµ±åˆCDKãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ

#### 1. CDK Pipelinesã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ (3æ™‚é–“)
- [ ] ã‚»ãƒ«ãƒ•å¤‰æ›´å‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ
- [ ] ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆè¨­è¨ˆ
- [ ] æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµ±åˆ (3æ™‚é–“)
- [ ] SASTï¼ˆé™çš„è§£æï¼‰çµ±åˆ
- [ ] DASTï¼ˆå‹•çš„è§£æï¼‰çµ±åˆ
- [ ] ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
- [ ] Infrastructure as Code ã‚¹ã‚­ãƒ£ãƒ³

#### 3. åŸºæœ¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£… (2æ™‚é–“)
- [ ] CDK Pipeline Stackä½œæˆ
- [ ] GitHubçµ±åˆè¨­å®š
- [ ] åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°ç®¡ç†

### Day 2: GitHub Actionsçµ±åˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

#### 1. GitHub Actionsè¨­å®š (3æ™‚é–“)
- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š
- [ ] OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ç®¡ç†
- [ ] ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ“ãƒ«ãƒ‰è¨­å®š

#### 2. ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯çµ±åˆ (3æ™‚é–“)
- [ ] AWS Config Rulesæ¤œè¨¼
- [ ] BLEAæº–æ‹ æ€§ãƒã‚§ãƒƒã‚¯
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼æ¤œè¨¼
- [ ] è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½

#### 3. ç›£è¦–ãƒ»é€šçŸ¥è¨­å®š (2æ™‚é–“)
- [ ] ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç›£è¦–è¨­å®š
- [ ] å¤±æ•—æ™‚é€šçŸ¥è¨­å®š
- [ ] Slackçµ±åˆ
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ

### MCP ã‚µãƒ¼ãƒæ´»ç”¨

```
ğŸ’¬ "æ¦‚è¦è¨­è¨ˆæ›¸ã®BLEAçµ±åˆCI/CDã«å¾“ã£ã¦ã€GitHub Actionsã§CDKçµ±ä¸€ã®
è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚BLEAã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã€
Configæº–æ‹ æ€§ãƒã‚§ãƒƒã‚¯ã€CDKçµ±åˆãƒ†ã‚¹ãƒˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚"
```

## æˆæœç‰©

### 1. CDK Pipeline Stackå®Ÿè£…

```typescript
// lib/pipeline/chatapp-pipeline-stack.ts
export class ChatAppPipelineStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props: cdk.StackProps) {
    super(scope, id, props);

    // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®š
    const sourceConnection = new codeconnections.CfnConnection(this, 'GitHubConnection', {
      connectionName: 'chatapp-github-connection',
      providerType: 'GitHub'
    });

    const source = pipelines.CodePipelineSource.connection(
      'your-org/aws-chat-app',
      'main',
      {
        connectionArn: sourceConnection.attrConnectionArn
      }
    );

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã®åˆæˆã‚¹ãƒ†ãƒƒãƒ—
    const synthStep = new pipelines.ShellStep('Synth', {
      input: source,
      commands: [
        // ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        'npm ci',
        'pip install -r requirements.txt',
        
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        'npm audit --audit-level high',
        'pip-audit -r requirements.txt',
        
        // é™çš„è§£æ
        'npm run lint',
        'npm run typecheck',
        'bandit -r backend/',
        
        // CDKåˆæˆ
        'npm run build',
        'npx cdk synth'
      ],
      primaryOutputDirectory: 'cdk.out'
    });

    // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½œæˆ
    const pipeline = new pipelines.CodePipeline(this, 'ChatAppPipeline', {
      pipelineName: 'ChatApp-BLEA-Pipeline',
      synth: synthStep,
      
      // ã‚»ãƒ«ãƒ•å¤‰æ›´æœ‰åŠ¹åŒ–
      selfMutation: true,
      
      // ã‚¯ãƒ­ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ä½¿ç”¨
      crossAccountKeys: true,
      
      // BLEAæº–æ‹ ã®IAMãƒ­ãƒ¼ãƒ«
      codeBuildDefaults: {
        rolePolicy: [
          new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
              'sts:AssumeRole',
              'iam:PassRole',
              'cloudformation:*',
              'lambda:*',
              'apigateway:*',
              'rds:*',
              's3:*',
              'kms:*'
            ],
            resources: ['*'],
            conditions: {
              StringEquals: {
                'aws:RequestedRegion': ['ap-northeast-1']
              }
            }
          })
        ]
      }
    });

    // é–‹ç™ºç’°å¢ƒã‚¹ãƒ†ãƒ¼ã‚¸
    const devStage = new ChatAppStage(this, 'Dev', {
      env: {
        account: process.env.CDK_DEFAULT_ACCOUNT!,
        region: 'ap-northeast-1'
      },
      stageName: 'dev'
    });

    const devStageDeployment = pipeline.addStage(devStage, {
      pre: [
        // BLEAæº–æ‹ æ€§äº‹å‰ãƒã‚§ãƒƒã‚¯
        new pipelines.ShellStep('BLEA-Pre-Check', {
          commands: [
            'echo "Running BLEA compliance pre-check"',
            'python scripts/blea-compliance-check.py --stage dev'
          ]
        })
      ],
      post: [
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
        new pipelines.ShellStep('Security-Tests', {
          commands: [
            'npm run test:security',
            'python scripts/dast-scan.py --target $DEV_API_URL'
          ],
          env: {
            DEV_API_URL: devStage.apiUrl
          }
        }),
        
        // çµ±åˆãƒ†ã‚¹ãƒˆ
        new pipelines.ShellStep('Integration-Tests', {
          commands: [
            'npm run test:integration',
            'python scripts/blea-validation.py --environment dev'
          ]
        })
      ]
    });

    // æœ¬ç•ªç’°å¢ƒã‚¹ãƒ†ãƒ¼ã‚¸
    const prodStage = new ChatAppStage(this, 'Prod', {
      env: {
        account: process.env.PROD_ACCOUNT_ID!,
        region: 'ap-northeast-1'
      },
      stageName: 'prod'
    });

    pipeline.addStage(prodStage, {
      pre: [
        // æ‰‹å‹•æ‰¿èª
        new pipelines.ManualApprovalStep('Approve-Production-Deployment', {
          comment: 'Please review the security scan results and approve production deployment'
        }),
        
        // æœ¬ç•ªå‰æœ€çµ‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        new pipelines.ShellStep('Final-Security-Check', {
          commands: [
            'python scripts/final-security-validation.py',
            'python scripts/blea-prod-readiness.py'
          ]
        })
      ],
      post: [
        // æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼
        new pipelines.ShellStep('Production-Validation', {
          commands: [
            'python scripts/prod-health-check.py',
            'python scripts/blea-prod-validation.py'
          ]
        })
      ]
    });

    // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—é€šçŸ¥
    this.setupFailureNotifications(pipeline);
  }

  private setupFailureNotifications(pipeline: pipelines.CodePipeline) {
    const notificationTopic = new sns.Topic(this, 'PipelineFailureNotifications', {
      topicName: 'ChatApp-Pipeline-Failures'
    });

    // Slackçµ±åˆ
    new chatbot.SlackChannelConfiguration(this, 'PipelineSlackNotifications', {
      slackChannelConfigurationName: 'chatapp-pipeline-alerts',
      slackWorkspaceId: process.env.SLACK_WORKSPACE_ID!,
      slackChannelId: process.env.SLACK_CHANNEL_ID!,
      notificationTopics: [notificationTopic]
    });

    // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—æ™‚ã®é€šçŸ¥ãƒ«ãƒ¼ãƒ«
    pipeline.pipeline.onStateChange('PipelineFailure', {
      target: new targets.SnsTopic(notificationTopic),
      eventPattern: {
        detail: {
          state: ['FAILED']
        }
      }
    });
  }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸
export class ChatAppStage extends cdk.Stage {
  public readonly apiUrl: string;

  constructor(scope: Construct, id: string, props: ChatAppStageProps) {
    super(scope, id, props);

    // BLEA ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚¹ã‚¿ãƒƒã‚¯
    const governanceStack = new BLEAGovernanceStack(this, 'Governance', props);

    // VPCã‚¹ã‚¿ãƒƒã‚¯
    const vpcStack = new BLEAVPCStack(this, 'VPC', {
      ...props,
      bleaContext: governanceStack
    });

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ãƒƒã‚¯
    const databaseStack = new BLEAAuroraStack(this, 'Database', {
      ...props,
      vpc: vpcStack.vpc,
      securityGroups: vpcStack.securityGroups
    });

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ãƒƒã‚¯
    const appStack = new ChatAppAPIStack(this, 'API', {
      ...props,
      vpc: vpcStack.vpc,
      database: databaseStack.cluster,
      databaseSecret: databaseStack.secret
    });

    this.apiUrl = appStack.api.url;

    // BLEAæº–æ‹ ã®ä¾å­˜é–¢ä¿‚è¨­å®š
    vpcStack.addDependency(governanceStack);
    databaseStack.addDependency(vpcStack);
    appStack.addDependency(databaseStack);
  }
}
```

### 2. GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```yaml
# .github/workflows/blea-cicd.yml
name: BLEA Integrated CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: ap-northeast-1
  NODE_VERSION: 18
  PYTHON_VERSION: 3.11

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          npm ci
          pip install -r requirements.txt
          pip install bandit safety semgrep

      - name: Run npm audit
        run: npm audit --audit-level high

      - name: Run Python security scan
        run: |
          bandit -r backend/ -f json -o bandit-report.json || true
          safety check --json --output safety-report.json || true

      - name: Run Semgrep SAST
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep-report.json

      - name: Check security thresholds
        run: |
          python scripts/security-gate-check.py \
            --bandit-report bandit-report.json \
            --safety-report safety-report.json \
            --semgrep-report semgrep-report.json

  infrastructure-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install security scanners
        run: |
          npm install -g @aws-cdk/cli
          pip install checkov

      - name: Synthesize CDK
        run: |
          npm run build
          npx cdk synth --all

      - name: Run Checkov scan
        run: |
          checkov -d cdk.out --framework cloudformation \
            --output json --output-file checkov-report.json || true

      - name: Run CDK security analysis
        run: |
          python scripts/cdk-security-analysis.py \
            --cdk-out cdk.out \
            --output cdk-security-report.json

      - name: Check infrastructure security
        run: |
          python scripts/infrastructure-security-gate.py \
            --checkov-report checkov-report.json \
            --cdk-report cdk-security-report.json

  blea-compliance:
    name: BLEA Compliance Check
    runs-on: ubuntu-latest
    needs: [security-scan, infrastructure-scan]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install BLEA tools
        run: |
          pip install boto3 botocore
          git clone https://github.com/aws-samples/baseline-environment-on-aws.git
          pip install -r baseline-environment-on-aws/requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run BLEA compliance check
        run: |
          python scripts/blea-compliance-validator.py \
            --config baseline-environment-on-aws/config \
            --output blea-compliance-report.json

      - name: Validate security standards
        run: |
          python scripts/security-standards-check.py \
            --standards cis-aws-foundations \
            --output security-standards-report.json

      - name: Upload compliance reports
        uses: actions/upload-artifact@v3
        with:
          name: compliance-reports
          path: |
            blea-compliance-report.json
            security-standards-report.json

  deploy-pipeline:
    name: Deploy CDK Pipeline
    runs-on: ubuntu-latest
    needs: [blea-compliance]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_PIPELINE_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy pipeline
        run: |
          npm run build
          npx cdk deploy ChatApp-Pipeline-Stack \
            --require-approval never \
            --context blea-enabled=true

      - name: Verify pipeline deployment
        run: |
          python scripts/pipeline-health-check.py \
            --pipeline-name ChatApp-BLEA-Pipeline

  notification:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy-pipeline]
    if: always()
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#chatapp-ci-cd'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# scripts/blea-compliance-validator.py
"""
BLEAæº–æ‹ æ€§æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import json
import boto3
import argparse
import sys
from typing import Dict, List, Any

class BLEAComplianceValidator:
    def __init__(self, region='ap-northeast-1'):
        self.region = region
        self.config_client = boto3.client('config', region_name=region)
        self.security_hub_client = boto3.client('securityhub', region_name=region)
        self.cloudtrail_client = boto3.client('cloudtrail', region_name=region)
        
    def validate_blea_services(self) -> Dict[str, Any]:
        """BLEAã‚µãƒ¼ãƒ“ã‚¹ã®æœ‰åŠ¹åŒ–çŠ¶æ³ç¢ºèª"""
        results = {
            'cloudtrail': self.check_cloudtrail_enabled(),
            'config': self.check_config_enabled(),
            'security_hub': self.check_security_hub_enabled(),
            'guardduty': self.check_guardduty_enabled()
        }
        return results
    
    def check_cloudtrail_enabled(self) -> Dict[str, Any]:
        """CloudTrailæœ‰åŠ¹åŒ–ç¢ºèª"""
        try:
            trails = self.cloudtrail_client.describe_trails()
            
            active_trails = []
            for trail in trails['trailList']:
                status = self.cloudtrail_client.get_trail_status(
                    Name=trail['TrailARN']
                )
                if status['IsLogging']:
                    active_trails.append({
                        'name': trail['Name'],
                        'is_multi_region': trail.get('IsMultiRegionTrail', False),
                        'include_global_events': trail.get('IncludeGlobalServiceEvents', False)
                    })
            
            return {
                'enabled': len(active_trails) > 0,
                'active_trails': active_trails,
                'compliance_status': 'COMPLIANT' if active_trails else 'NON_COMPLIANT'
            }
        except Exception as e:
            return {
                'enabled': False,
                'error': str(e),
                'compliance_status': 'NON_COMPLIANT'
            }
    
    def check_config_enabled(self) -> Dict[str, Any]:
        """AWS Configæœ‰åŠ¹åŒ–ç¢ºèª"""
        try:
            recorders = self.config_client.describe_configuration_recorders()
            delivery_channels = self.config_client.describe_delivery_channels()
            
            active_recorders = []
            for recorder in recorders['ConfigurationRecorders']:
                status = self.config_client.describe_configuration_recorder_status(
                    ConfigurationRecorderNames=[recorder['name']]
                )
                if status['ConfigurationRecordersStatus'][0]['recording']:
                    active_recorders.append(recorder['name'])
            
            return {
                'enabled': len(active_recorders) > 0 and len(delivery_channels['DeliveryChannels']) > 0,
                'active_recorders': active_recorders,
                'delivery_channels': len(delivery_channels['DeliveryChannels']),
                'compliance_status': 'COMPLIANT' if active_recorders and delivery_channels['DeliveryChannels'] else 'NON_COMPLIANT'
            }
        except Exception as e:
            return {
                'enabled': False,
                'error': str(e),
                'compliance_status': 'NON_COMPLIANT'
            }
    
    def check_security_hub_enabled(self) -> Dict[str, Any]:
        """Security Hubæœ‰åŠ¹åŒ–ç¢ºèª"""
        try:
            hub = self.security_hub_client.describe_hub()
            standards = self.security_hub_client.get_enabled_standards()
            
            return {
                'enabled': True,
                'hub_arn': hub['HubArn'],
                'enabled_standards': len(standards['StandardsSubscriptions']),
                'compliance_status': 'COMPLIANT'
            }
        except self.security_hub_client.exceptions.InvalidAccessException:
            return {
                'enabled': False,
                'error': 'Security Hub not enabled',
                'compliance_status': 'NON_COMPLIANT'
            }
        except Exception as e:
            return {
                'enabled': False,
                'error': str(e),
                'compliance_status': 'NON_COMPLIANT'
            }
    
    def check_guardduty_enabled(self) -> Dict[str, Any]:
        """GuardDutyæœ‰åŠ¹åŒ–ç¢ºèª"""
        try:
            guardduty_client = boto3.client('guardduty', region_name=self.region)
            detectors = guardduty_client.list_detectors()
            
            active_detectors = []
            for detector_id in detectors['DetectorIds']:
                detector = guardduty_client.get_detector(DetectorId=detector_id)
                if detector['Status'] == 'ENABLED':
                    active_detectors.append({
                        'detector_id': detector_id,
                        'finding_frequency': detector['FindingPublishingFrequency'],
                        'data_sources': detector.get('DataSources', {})
                    })
            
            return {
                'enabled': len(active_detectors) > 0,
                'active_detectors': active_detectors,
                'compliance_status': 'COMPLIANT' if active_detectors else 'NON_COMPLIANT'
            }
        except Exception as e:
            return {
                'enabled': False,
                'error': str(e),
                'compliance_status': 'NON_COMPLIANT'
            }
    
    def validate_config_rules(self) -> Dict[str, Any]:
        """AWS Config Rulesæº–æ‹ æ€§ç¢ºèª"""
        try:
            rules = self.config_client.describe_config_rules()
            compliance_results = {}
            
            for rule in rules['ConfigRules']:
                try:
                    compliance = self.config_client.get_compliance_details_by_config_rule(
                        ConfigRuleName=rule['ConfigRuleName']
                    )
                    
                    compliance_summary = {
                        'compliant': 0,
                        'non_compliant': 0,
                        'not_applicable': 0
                    }
                    
                    for result in compliance['EvaluationResults']:
                        status = result['ComplianceType'].lower().replace('_', ' ')
                        if status in compliance_summary:
                            compliance_summary[status] += 1
                    
                    compliance_results[rule['ConfigRuleName']] = {
                        'source': rule['Source']['Owner'],
                        'compliance_summary': compliance_summary,
                        'overall_compliance': 'COMPLIANT' if compliance_summary['non_compliant'] == 0 else 'NON_COMPLIANT'
                    }
                except Exception as rule_error:
                    compliance_results[rule['ConfigRuleName']] = {
                        'error': str(rule_error),
                        'overall_compliance': 'ERROR'
                    }
            
            return {
                'total_rules': len(rules['ConfigRules']),
                'rule_details': compliance_results,
                'overall_compliance': 'COMPLIANT' if all(
                    result.get('overall_compliance') == 'COMPLIANT' 
                    for result in compliance_results.values()
                ) else 'NON_COMPLIANT'
            }
        except Exception as e:
            return {
                'error': str(e),
                'overall_compliance': 'ERROR'
            }
    
    def generate_compliance_report(self) -> Dict[str, Any]:
        """ç·åˆBLEAæº–æ‹ æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""
        print("Validating BLEA compliance...")
        
        blea_services = self.validate_blea_services()
        config_rules = self.validate_config_rules()
        
        # ç·åˆåˆ¤å®š
        service_compliance = all(
            service['compliance_status'] == 'COMPLIANT' 
            for service in blea_services.values()
        )
        
        rules_compliance = config_rules.get('overall_compliance') == 'COMPLIANT'
        
        overall_compliance = service_compliance and rules_compliance
        
        report = {
            'timestamp': boto3.Session().get_available_regions('ec2')[0],  # placeholder
            'region': self.region,
            'blea_services': blea_services,
            'config_rules': config_rules,
            'overall_compliance': 'COMPLIANT' if overall_compliance else 'NON_COMPLIANT',
            'recommendations': self.generate_recommendations(blea_services, config_rules)
        }
        
        return report
    
    def generate_recommendations(self, services: Dict, rules: Dict) -> List[str]:
        """æ”¹å–„æ¨å¥¨äº‹é …ç”Ÿæˆ"""
        recommendations = []
        
        for service_name, service_status in services.items():
            if service_status['compliance_status'] != 'COMPLIANT':
                recommendations.append(f"Enable {service_name.title()} service")
        
        if rules.get('overall_compliance') != 'COMPLIANT':
            recommendations.append("Review and remediate non-compliant Config Rules")
        
        return recommendations

def main():
    parser = argparse.ArgumentParser(description='BLEA Compliance Validator')
    parser.add_argument('--region', default='ap-northeast-1', help='AWS Region')
    parser.add_argument('--output', required=True, help='Output JSON file')
    
    args = parser.parse_args()
    
    try:
        validator = BLEAComplianceValidator(region=args.region)
        report = validator.generate_compliance_report()
        
        with open(args.output, 'w') as f:
            json.dump(report, f, indent=2, default=str)
        
        print(f"Compliance report generated: {args.output}")
        print(f"Overall compliance: {report['overall_compliance']}")
        
        # éæº–æ‹ ã®å ´åˆã¯çµ‚äº†ã‚³ãƒ¼ãƒ‰1ã§çµ‚äº†
        if report['overall_compliance'] != 'COMPLIANT':
            print("BLEA compliance validation failed!")
            sys.exit(1)
        else:
            print("BLEA compliance validation passed!")
            
    except Exception as e:
        print(f"Error during validation: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

## æ¤œè¨¼é …ç›®

- [ ] GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] CDK Pipeline ãŒä½œæˆã•ã‚Œã‚‹
- [ ] è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] æ‰‹å‹•æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ãŒå‹•ä½œã™ã‚‹
- [ ] BLEAæº–æ‹ æ€§ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- [ ] å¤±æ•—æ™‚é€šçŸ¥ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] Slackçµ±åˆãŒå‹•ä½œã™ã‚‹

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- [ ] OIDCèªè¨¼ã®é©åˆ‡ãªè¨­å®š
- [ ] æœ€å°æ¨©é™IAMãƒ­ãƒ¼ãƒ«ã®å®Ÿè£…
- [ ] ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã®å¾¹åº•
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®é–¾å€¤è¨­å®š
- [ ] ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç›£æŸ»ãƒ­ã‚°ã®è¨˜éŒ²
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã®å®Ÿè£…

## æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸ã®å¼•ãç¶™ãäº‹é …

- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®šè©³ç´°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ
- ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥æƒ…å ±
- ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šçŠ¶æ³

## å‚è€ƒè³‡æ–™

- [AWS CDK Pipelines](https://docs.aws.amazon.com/cdk/v2/guide/cdk_pipeline.html)
- [GitHub Actions OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)
- [AWS DevSecOps](https://aws.amazon.com/solutions/implementations/devsecops-on-aws/)