# Task: AppSync + EventBridge ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½å®Ÿè£…

**å®Ÿæ–½æœŸé–“**: Month 2 Week 1 (Day 1-2)  
**æ¨å®šå·¥æ•°**: 8æ™‚é–“  
**å„ªå…ˆåº¦**: é«˜  

## æ¦‚è¦

BLEAç›£è¦–ä¸‹ã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã€AppSync GraphQL + Subscriptionsã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## å­¦ç¿’ç›®æ¨™

- AppSync GraphQLã‚µãƒ¼ãƒãƒ¼ã®è¨­è¨ˆãƒ»å®Ÿè£…
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ Subscriptionsã®å®Ÿè£…
- EventBridgeã¨ã®çµ±åˆã«ã‚ˆã‚‹ç–çµåˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ
- BLEAç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº

## å‰ææ¡ä»¶

- Month 1ã®å…¨ã‚¿ã‚¹ã‚¯å®Œäº†
- Aurora Databaseæ§‹ç¯‰å®Œäº†
- Lambda + API Gatewayå®Ÿè£…å®Œäº†

## ã‚¿ã‚¹ã‚¯è©³ç´°

### Day 1: AppSync GraphQLå®Ÿè£…

#### 1. AppSyncè¨­è¨ˆã¨ã‚¹ã‚­ãƒ¼ãƒå®šç¾© (3æ™‚é–“)
- [ ] GraphQLã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ
- [ ] ãƒªã‚¾ãƒ«ãƒãƒ¼è¨­è¨ˆï¼ˆLambda/Direct Lambdaï¼‰
- [ ] Subscriptionè¨­è¨ˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šï¼ˆCognitoçµ±åˆï¼‰

#### 2. CDKã«ã‚ˆã‚‹AppSyncæ§‹ç¯‰ (3æ™‚é–“)
- [ ] AppSync APIä½œæˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®šï¼ˆLambda/Auroraï¼‰
- [ ] ãƒªã‚¾ãƒ«ãƒãƒ¼å®Ÿè£…
- [ ] WAFçµ±åˆè¨­å®š

#### 3. åŸºæœ¬GraphQLæ©Ÿèƒ½å®Ÿè£… (2æ™‚é–“)
- [ ] Queryå®Ÿè£…ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ï¼‰
- [ ] Mutationå®Ÿè£…ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼‰
- [ ] BLEAçµ±åˆãƒ­ã‚°è¨­å®š
- [ ] X-Rayçµ±åˆ

### Day 2: Subscriptions ã¨EventBridgeçµ±åˆ

#### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ Subscriptionså®Ÿè£… (3æ™‚é–“)
- [ ] Message Subscriptions
- [ ] User Status Subscriptions
- [ ] Room Event Subscriptions
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆSubscriptions

#### 2. EventBridgeçµ±åˆ (3æ™‚é–“)
- [ ] EventBridgeè¨­å®š
- [ ] ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ«è¨­å®š
- [ ] Lambdaçµ±åˆ

#### 3. ç›£è¦–ãƒ»ãƒ­ã‚°çµ±åˆ (2æ™‚é–“)
- [ ] AppSync CloudWatchçµ±åˆ
- [ ] BLEA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- [ ] ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

### MCP ã‚µãƒ¼ãƒæ´»ç”¨

```
ğŸ’¬ "æ¦‚è¦è¨­è¨ˆæ›¸ã«å¾“ã£ã¦ã€AppSync GraphQLã¨Subscriptionsã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
BLEAç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã€X-Rayçµ±åˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚
EventBridgeã¨ã®é€£æºã‚‚å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚"
```

## æˆæœç‰©

### 1. AppSync CDKå®Ÿè£…

```typescript
// lib/graphql/appsync-stack.ts
export class ChatAppGraphQLStack extends cdk.Stack {
  public readonly api: appsync.GraphqlApi;
  public readonly eventBus: events.EventBus;

  constructor(scope: Construct, id: string, props: ChatAppGraphQLStackProps) {
    super(scope, id, props);

    // AppSync APIä½œæˆ
    this.api = new appsync.GraphqlApi(this, 'ChatAppGraphQLAPI', {
      name: 'ChatApp-GraphQL-API',
      schema: appsync.SchemaFile.fromAsset('schema/schema.graphql'),
      authorizationConfig: {
        defaultAuthorization: {
          authorizationType: appsync.AuthorizationType.USER_POOL,
          userPoolConfig: {
            userPool: props.userPool,
            defaultAction: appsync.UserPoolDefaultAction.ALLOW
          }
        }
      },
      // X-Rayçµ±åˆ
      xrayEnabled: true,
      // ãƒ­ã‚°è¨­å®š
      logConfig: {
        level: appsync.LogLevel.ALL,
        retention: logs.RetentionDays.ONE_MONTH
      }
    });

    // EventBridge ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¹
    this.eventBus = new events.EventBus(this, 'ChatAppEventBus', {
      eventBusName: 'ChatApp-Events'
    });

    // Aurora ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
    const auroraDataSource = this.api.addRdsDataSource(
      'AuroraDataSource',
      props.cluster,
      props.databaseSecret,
      'chatapp'
    );

    // Lambda ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
    const messageLambda = this.createMessageLambda(props);
    const lambdaDataSource = this.api.addLambdaDataSource(
      'MessageLambdaDataSource',
      messageLambda
    );

    // EventBridge ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
    const eventBridgeDataSource = this.api.addEventBridgeDataSource(
      'EventBridgeDataSource',
      this.eventBus
    );

    // ãƒªã‚¾ãƒ«ãƒãƒ¼è¨­å®š
    this.createResolvers(auroraDataSource, lambdaDataSource, eventBridgeDataSource);

    // WAFçµ±åˆ
    this.attachWAF();
  }

  private createMessageLambda(props: ChatAppGraphQLStackProps): lambda.Function {
    return new lambda.Function(this, 'GraphQLMessageHandler', {
      runtime: lambda.Runtime.PYTHON_3_11,
      handler: 'handler.lambda_handler',
      code: lambda.Code.fromAsset('backend/graphql'),
      environment: {
        DATABASE_SECRET_ARN: props.databaseSecret.secretArn,
        EVENT_BUS_NAME: this.eventBus.eventBusName,
        SECURITY_HUB_REGION: this.region
      },
      vpc: props.vpc,
      vpcSubnets: {
        subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS
      },
      // BLEAæº–æ‹ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
      securityGroups: [props.lambdaSecurityGroup],
      // X-Rayçµ±åˆ
      tracing: lambda.Tracing.ACTIVE,
      // ç›£è¦–è¨­å®š
      deadLetterQueue: new sqs.Queue(this, 'GraphQLDLQ'),
      timeout: cdk.Duration.seconds(30)
    });
  }

  private createResolvers(
    auroraDs: appsync.BaseDataSource,
    lambdaDs: appsync.BaseDataSource,
    eventDs: appsync.BaseDataSource
  ) {
    // Query ãƒªã‚¾ãƒ«ãƒãƒ¼
    this.api.createResolver('GetMessagesResolver', {
      typeName: 'Query',
      fieldName: 'messages',
      dataSource: auroraDs,
      requestMappingTemplate: appsync.MappingTemplate.fromFile('resolvers/Query.messages.req.vtl'),
      responseMappingTemplate: appsync.MappingTemplate.fromFile('resolvers/Query.messages.res.vtl')
    });

    // Mutation ãƒªã‚¾ãƒ«ãƒãƒ¼
    this.api.createResolver('SendMessageResolver', {
      typeName: 'Mutation',
      fieldName: 'sendMessage',
      dataSource: lambdaDs,
      requestMappingTemplate: appsync.MappingTemplate.lambdaRequest(),
      responseMappingTemplate: appsync.MappingTemplate.lambdaResult()
    });

    // Subscription ãƒªã‚¾ãƒ«ãƒãƒ¼
    this.api.createResolver('MessageAddedResolver', {
      typeName: 'Subscription',
      fieldName: 'messageAdded',
      dataSource: eventDs,
      requestMappingTemplate: appsync.MappingTemplate.fromString(`
        {
          "version": "2018-05-29",
          "operation": "PutEvents",
          "events": [
            {
              "source": "chatapp.messages",
              "detailType": "Message Added",
              "detail": $util.toJson($context.arguments)
            }
          ]
        }
      `),
      responseMappingTemplate: appsync.MappingTemplate.fromString('$util.toJson($context.result)')
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆSubscription
    this.api.createResolver('SecurityEventResolver', {
      typeName: 'Subscription',
      fieldName: 'securityEventAdded',
      dataSource: eventDs
    });
  }

  private attachWAF() {
    const webAcl = new wafv2.CfnWebACL(this, 'GraphQLWebACL', {
      scope: 'CLOUDFRONT',
      defaultAction: { allow: {} },
      rules: [
        {
          name: 'AWSManagedRulesGraphQLRuleSet',
          priority: 1,
          statement: {
            managedRuleGroupStatement: {
              vendorName: 'AWS',
              name: 'AWSManagedRulesCommonRuleSet'
            }
          },
          overrideAction: { none: {} },
          visibilityConfig: {
            sampledRequestsEnabled: true,
            cloudWatchMetricsEnabled: true,
            metricName: 'GraphQLRuleSetMetric'
          }
        },
        // GraphQLç‰¹æœ‰ã®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾ç­–
        {
          name: 'GraphQLDepthLimit',
          priority: 2,
          statement: {
            byteMatchStatement: {
              searchString: 'query',
              fieldToMatch: { body: {} },
              textTransformations: [
                { priority: 0, type: 'LOWERCASE' }
              ],
              positionalConstraint: 'CONTAINS'
            }
          },
          action: { allow: {} },
          visibilityConfig: {
            sampledRequestsEnabled: true,
            cloudWatchMetricsEnabled: true,
            metricName: 'GraphQLDepthLimitMetric'
          }
        }
      ]
    });

    // CloudFront ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«WAFé©ç”¨
    new wafv2.CfnWebACLAssociation(this, 'GraphQLWebACLAssociation', {
      resourceArn: `arn:aws:apigateway:${this.region}::/restapis/${this.api.apiId}/stages/*`,
      webAclArn: webAcl.attrArn
    });
  }
}
```

### 2. GraphQLã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```graphql
# schema/schema.graphql
type Query {
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£
  messages(roomId: ID!, limit: Int = 50, nextToken: String): MessageConnection
  message(id: ID!): Message
  
  # ãƒ«ãƒ¼ãƒ é–¢é€£
  rooms(limit: Int = 20): RoomConnection
  room(id: ID!): Room
  
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£
  me: User
  onlineUsers(roomId: ID!): [OnlineUser]
  
  # BLEAçµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
  securityEvents(limit: Int = 50, severity: SecuritySeverity): SecurityEventConnection
  auditLogs(limit: Int = 50): AuditLogConnection
}

type Mutation {
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œ
  sendMessage(input: SendMessageInput!): Message
  editMessage(messageId: ID!, content: String!): Message
  deleteMessage(messageId: ID!): Boolean
  
  # ãƒ«ãƒ¼ãƒ æ“ä½œ
  createRoom(input: CreateRoomInput!): Room
  joinRoom(roomId: ID!): RoomMember
  leaveRoom(roomId: ID!): Boolean
  
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹
  updateUserStatus(status: UserStatus!, roomId: ID): Session
  
  # BLEAçµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
  reportSecurityEvent(input: SecurityEventInput!): SecurityEvent
}

type Subscription {
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
  messageAdded(roomId: ID!): Message
    @aws_subscribe(mutations: ["sendMessage"])
  
  messageUpdated(roomId: ID!): Message
    @aws_subscribe(mutations: ["editMessage"])
  
  messageDeleted(roomId: ID!): MessageDeleted
    @aws_subscribe(mutations: ["deleteMessage"])
  
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°
  userStatusChanged(roomId: ID!): OnlineUser
    @aws_subscribe(mutations: ["updateUserStatus"])
  
  # BLEAçµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ
  securityEventAdded: SecurityEvent
    @aws_subscribe(mutations: ["reportSecurityEvent"])
  
  # ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç®¡ç†è€…å‘ã‘ï¼‰
  systemAlert: SystemAlert
    @aws_auth(cognito_groups: ["Administrators"])
}

# å‹å®šç¾©
type Message {
  id: ID!
  content: String!
  messageType: MessageType!
  user: User!
  room: Room!
  replyTo: Message
  isEdited: Boolean!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type User {
  id: ID!
  username: String!
  displayName: String
  email: AWSEmail!
  avatarUrl: AWSURL
  lastLoginAt: AWSDateTime
  isActive: Boolean!
  createdAt: AWSDateTime!
}

type Room {
  id: ID!
  name: String!
  description: String
  roomType: RoomType!
  memberCount: Int!
  lastMessage: Message
  unreadCount: Int
  createdAt: AWSDateTime!
}

# BLEAçµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‹
type SecurityEvent {
  id: ID!
  eventType: String!
  severity: SecuritySeverity!
  sourceService: String!
  user: User
  sourceIp: String
  eventDetails: AWSJSON!
  createdAt: AWSDateTime!
  resolved: Boolean!
}

type AuditLog {
  id: ID!
  tableName: String!
  operation: String!
  user: User
  changedFields: [String]
  createdAt: AWSDateTime!
}

# åˆ—æŒ™å‹
enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum RoomType {
  PUBLIC
  PRIVATE
  DIRECT
}

enum UserStatus {
  ONLINE
  AWAY
  OFFLINE
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

# å…¥åŠ›å‹
input SendMessageInput {
  roomId: ID!
  content: String!
  messageType: MessageType = TEXT
  replyToId: ID
}

input CreateRoomInput {
  name: String!
  description: String
  roomType: RoomType = PUBLIC
}

input SecurityEventInput {
  eventType: String!
  severity: SecuritySeverity!
  sourceService: String!
  eventDetails: AWSJSON!
}

# æ¥ç¶šå‹
type MessageConnection {
  items: [Message]
  nextToken: String
}

type RoomConnection {
  items: [Room]
  nextToken: String
}

type SecurityEventConnection {
  items: [SecurityEvent]
  nextToken: String
}

type AuditLogConnection {
  items: [AuditLog]
  nextToken: String
}

# ã‚¤ãƒ™ãƒ³ãƒˆå‹
type MessageDeleted {
  messageId: ID!
  roomId: ID!
  deletedBy: User!
  deletedAt: AWSDateTime!
}

type OnlineUser {
  user: User!
  status: UserStatus!
  lastActivity: AWSDateTime!
}

type SystemAlert {
  id: ID!
  type: String!
  severity: SecuritySeverity!
  message: String!
  createdAt: AWSDateTime!
}
```

### 3. Lambda GraphQL Handler

```python
# backend/graphql/handler.py
import json
import boto3
import os
from datetime import datetime
from aws_lambda_powertools import Logger, Tracer, Metrics
from aws_lambda_powertools.metrics import MetricUnit

logger = Logger()
tracer = Tracer()
metrics = Metrics()

# AWS clients
eventbridge = boto3.client('events')
secretsmanager = boto3.client('secretsmanager')
securityhub = boto3.client('securityhub')

@tracer.capture_lambda_handler
@logger.inject_lambda_context
@metrics.log_metrics
def lambda_handler(event, context):
    """
    AppSync GraphQL ãƒªã‚¾ãƒ«ãƒãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    """
    try:
        field_name = event['info']['fieldName']
        arguments = event.get('arguments', {})
        
        # BLEAç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
        log_graphql_request(event, context)
        
        # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥å‡¦ç†
        if field_name == 'sendMessage':
            return handle_send_message(arguments, event)
        elif field_name == 'reportSecurityEvent':
            return handle_security_event(arguments, event)
        else:
            raise ValueError(f"Unknown field: {field_name}")
            
    except Exception as e:
        logger.error(f"GraphQL handler error: {str(e)}")
        metrics.add_metric(name="GraphQLErrors", unit=MetricUnit.Count, value=1)
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
        report_security_event({
            'event_type': 'graphql_error',
            'severity': 'medium',
            'source_service': 'appsync',
            'event_details': {
                'error': str(e),
                'field_name': event.get('info', {}).get('fieldName'),
                'user_id': get_user_id_from_event(event)
            }
        })
        
        raise e

@tracer.capture_method
def handle_send_message(arguments, event):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†"""
    try:
        user_id = get_user_id_from_event(event)
        room_id = arguments['input']['roomId']
        content = arguments['input']['content']
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
        if not validate_message_content(content):
            report_security_event({
                'event_type': 'malicious_content_detected',
                'severity': 'high',
                'source_service': 'appsync',
                'event_details': {
                    'user_id': user_id,
                    'room_id': room_id,
                    'content_length': len(content)
                }
            })
            raise ValueError("Content validation failed")
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ï¼ˆAuroraã«ç›´æ¥ä¿å­˜ï¼‰
        message_id = save_message_to_database(arguments['input'], user_id)
        
        # EventBridgeçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡
        publish_message_event({
            'messageId': message_id,
            'roomId': room_id,
            'userId': user_id,
            'content': content,
            'timestamp': datetime.utcnow().isoformat()
        })
        
        # æˆåŠŸãƒ¡ãƒˆãƒªã‚¯ã‚¹
        metrics.add_metric(name="MessagesProcessed", unit=MetricUnit.Count, value=1)
        
        return {
            'id': message_id,
            'content': content,
            'messageType': arguments['input'].get('messageType', 'TEXT'),
            'createdAt': datetime.utcnow().isoformat()
        }
        
    except Exception as e:
        logger.error(f"Send message error: {str(e)}")
        metrics.add_metric(name="MessageErrors", unit=MetricUnit.Count, value=1)
        raise e

@tracer.capture_method
def handle_security_event(arguments, event):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Šå‡¦ç†"""
    try:
        user_id = get_user_id_from_event(event)
        security_event = arguments['input']
        
        # Security Hubã«é€ä¿¡
        finding_id = send_to_security_hub({
            **security_event,
            'reporter_user_id': user_id,
            'source_component': 'appsync_graphql'
        })
        
        # EventBridgeçµŒç”±ã§ç®¡ç†è€…ã«é€šçŸ¥
        publish_security_event({
            'findingId': finding_id,
            'eventType': security_event['eventType'],
            'severity': security_event['severity'],
            'reportedBy': user_id
        })
        
        return {
            'id': finding_id,
            'eventType': security_event['eventType'],
            'severity': security_event['severity'],
            'createdAt': datetime.utcnow().isoformat(),
            'resolved': False
        }
        
    except Exception as e:
        logger.error(f"Security event error: {str(e)}")
        raise e

def validate_message_content(content: str) -> bool:
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®å®‰å…¨æ€§æ¤œè¨¼"""
    # XSSæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
    dangerous_patterns = [
        '<script',
        'javascript:',
        'onclick=',
        'onerror=',
        'eval(',
        'document.cookie'
    ]
    
    content_lower = content.lower()
    for pattern in dangerous_patterns:
        if pattern in content_lower:
            return False
    
    return True

def log_graphql_request(event, context):
    """GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆç›£æŸ»ãƒ­ã‚°"""
    logger.info("GraphQL request", extra={
        'field_name': event.get('info', {}).get('fieldName'),
        'user_id': get_user_id_from_event(event),
        'request_id': context.aws_request_id,
        'source_ip': event.get('sourceIp'),
        'user_agent': event.get('userAgent')
    })

def get_user_id_from_event(event) -> str:
    """ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæŠ½å‡º"""
    identity = event.get('identity', {})
    return identity.get('sub') or identity.get('username', 'anonymous')

def publish_message_event(message_data):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’EventBridgeã«é€ä¿¡"""
    eventbridge.put_events(
        Entries=[{
            'Source': 'chatapp.messages',
            'DetailType': 'Message Added',
            'Detail': json.dumps(message_data),
            'EventBusName': os.environ['EVENT_BUS_NAME']
        }]
    )

def publish_security_event(security_data):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’EventBridgeã«é€ä¿¡"""
    eventbridge.put_events(
        Entries=[{
            'Source': 'chatapp.security',
            'DetailType': 'Security Event',
            'Detail': json.dumps(security_data),
            'EventBusName': os.environ['EVENT_BUS_NAME']
        }]
    )

def send_to_security_hub(security_event):
    """Security Hubã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‰€è¦‹é€ä¿¡"""
    finding_id = f"chatapp-{datetime.utcnow().strftime('%Y%m%d%H%M%S')}"
    
    securityhub.batch_import_findings(
        Findings=[{
            'SchemaVersion': '2018-10-08',
            'Id': finding_id,
            'ProductArn': f"arn:aws:securityhub:{os.environ['AWS_REGION']}::product/custom/chatapp",
            'GeneratorId': 'chatapp-appsync',
            'AwsAccountId': os.environ['AWS_ACCOUNT_ID'],
            'CreatedAt': datetime.utcnow().isoformat() + 'Z',
            'UpdatedAt': datetime.utcnow().isoformat() + 'Z',
            'Severity': {
                'Label': security_event['severity'].upper()
            },
            'Title': f"ChatApp Security Event: {security_event['eventType']}",
            'Description': json.dumps(security_event['eventDetails']),
            'Types': ['Unusual Behaviors/Application']
        }]
    )
    
    return finding_id
```

## æ¤œè¨¼é …ç›®

- [ ] AppSync API ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã‚‹
- [ ] GraphQL ã‚¯ã‚¨ãƒªãŒå‹•ä½œã™ã‚‹
- [ ] Mutations ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹
- [ ] Subscriptions ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] EventBridgeçµ±åˆãŒå‹•ä½œã™ã‚‹
- [ ] X-Ray ãƒˆãƒ¬ãƒ¼ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] WAF ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒå®‰å®šã—ã¦ã„ã‚‹

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- [ ] GraphQL ã‚¹ã‚­ãƒ¼ãƒã®æ·±åº¦åˆ¶é™
- [ ] ãƒªã‚¾ãƒ«ãƒãƒ¼ãƒ¬ãƒ™ãƒ«ã®èªè¨¼ãƒ»èªå¯
- [ ] ã‚¯ã‚¨ãƒªã®è¤‡é›‘åº¦åˆ¶é™
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…
- [ ] å…¥åŠ›å€¤æ¤œè¨¼ã®å®Ÿè£…
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š

## æ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸ã®å¼•ãç¶™ãäº‹é …

- AppSync API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæƒ…å ±
- EventBridge è¨­å®šè©³ç´°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆçŠ¶æ³
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ‡ãƒ¼ã‚¿

## å‚è€ƒè³‡æ–™

- [AWS AppSync](https://docs.aws.amazon.com/appsync/)
- [GraphQL Security](https://graphql.org/learn/security/)
- [EventBridge](https://docs.aws.amazon.com/eventbridge/)